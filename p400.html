<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>P400</title>
        <script src="https://js.stripe.com/terminal/v1/sdk-b1.js"></script>
        <script>
            function fetchConnectionToken() {
                return fetch('http://localhost:3000/connection-token', {
                    method: 'POST',
                })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    return data.secret;
                });
            }

            function connectReader(discoverResult) {
                // Just select the first reader here.
                var selectedReader = discoverResult.discoveredReaders[0];

                terminal.connectReader(selectedReader).then(function(connectResult) {
                    if (connectResult.error) {
                    console.log('Failed to connect: ', connectResult.error);
                    } else {
                    console.log('Connected to reader: ', connectResult.connection.reader.label);
                    }
                });
            }

            var terminal = StripeTerminal.create({
                onFetchConnectionToken: fetchConnectionToken
            });

            terminal.discoverReaders().then(function(discoverResult) {
                if (discoverResult.error) {
                    console.log('Failed to discover: ', discoverResult.error);
                } else if (discoverResult.discoveredReaders.length === 0) {
                    console.log('No available readers.');
                } else {
                    // You should show the list of discoveredReaders to the
                    // cashier here and let them select which to connect to (see below).
                    connectReader(discoverResult);
                }
            });
        </script>
    </head>
    <body>

    </body>
</html>